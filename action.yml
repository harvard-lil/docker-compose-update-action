name: 'Update docker-compose.yml and docker-compose.override.yml'
description: 'Update image versions in docker-compose.yml and docker-compose.override.yml, build and push image'

inputs:
  registry:
    description: 'Server address of container registry'
    required: true
    default: "docker.io"
  registry-user:
    description: 'User name for container registry'
    required: true
  registry-pass:
    description: 'Password for container registry'
    required: true
  working-directory:
    description: 'Working directory'
    required: true
    default: "."

outputs:
  services-rebuilt:
    description: "Services in docker-compose.override.yml that were rebuilt"
    value: ${{ steps.update-tags.outputs.services-to-rebuild }}

runs:
  using: "composite"
  steps:
    - name: Get current image and tag name
      id: update-tags
      working-directory: ${{ inputs.working-directory }}
      shell: bash
      run: |
        set -x
        pip install -r requirements.txt
        python ${{ github.action_path }}/update_tags.py

    - name: Set up QEMU
      if: steps.update-tags.outputs.services-to-rebuild != ''
      uses: docker/setup-qemu-action@v1

    - name: Set up Docker Buildx
      if: steps.update-tags.outputs.services-to-rebuild != ''
      uses: docker/setup-buildx-action@v1

    - name: Login to Docker Registry
      if: steps.update-tags.outputs.services-to-rebuild != '' && github.event_name == "push"
      uses: docker/login-action@v1
      with:
        registry: ${{inputs.registry}}
        username: ${{inputs.registry-user}}
        password: ${{inputs.registry-pass}}

    - name: Rebuild and push images
      if: steps.update-tags.outputs.services-to-rebuild != ''
      working-directory: ${{ inputs.working-directory }}
      shell: bash
      run: |
        set -x

        BUILD_COMMAND="docker buildx bake -f docker-compose.yml -f docker-compose.override.yml ${{ steps.update-tags.outputs.services-to-rebuild }}"

        if [ "${{ github.event_name }}" = "push" ]; then
          # build for all platforms and push to registry on pushes
          $BUILD_COMMAND --push

        else
          # just build for local tests on PRs
          $BUILD_COMMAND --set "*.platform=linux/amd64"
        fi
